<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸ ç·¨è¼¯ç¦®ç‰© (å¯è¦–åŒ–ç‰ˆ)</title>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue","Noto Sans TC",sans-serif;
  background:#f6f7f9;
  margin:0; padding:20px;
}

h1{
  font-size:1.5em;
  font-weight:700;
  text-align:center;
  margin-bottom:20px;
  color:#b30000;
}

/* å¡ç‰‡å¤–è§€ */
.card{
  background:#fff;
  padding:15px;
  margin-bottom:15px;
  border-radius:14px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
}

label{
  font-size:0.9em;
  font-weight:600;
  display:block;
  margin-bottom:4px;
}

input, textarea, select{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border:1px solid #ccc;
  border-radius:10px;
  font-size:14px;
}

button{
  padding:10px 16px;
  border:0;
  background:#d10000;
  color:#fff;
  font-size:14px;
  border-radius:8px;
  cursor:pointer;
}

.btn-small{
  padding:6px 10px;
  font-size:12px;
}

.btn-delete{
  background:#777;
}

#giftList .gift-item{
  background:#fff;
  padding:12px;
  border:1px solid #eee;
  border-radius:10px;
  margin-bottom:10px;
}

#msg{
  margin-top:10px;
  font-size:14px;
  color:green;
  text-align:center;
}
</style>


<body>

<h1>ğŸ ç”Ÿæ—¥ç¦®ç‰©ç·¨è¼¯å™¨ï¼ˆè¦–è¦ºåŒ–ï¼‰</h1>

<div class="card">
  <label>ä½ çš„ GitHub Token</label>
  <input id="tokenBox" type="password" placeholder="ç¬¬ä¸€æ¬¡ä½¿ç”¨è«‹è¼¸å…¥ Token">
  <button onclick="saveToken()">ğŸ’¾ ä¿å­˜ Tokenï¼ˆåªå­˜åœ¨ä½ çš„ç€è¦½å™¨ï¼‰</button>
</div>

<div class="card">
  <h3>ğŸ“¦ å·²è¨­å®šçš„ç¦®ç‰©</h3>
  <div id="giftList">è®€å–ä¸­...</div>
</div>

<div class="card">
  <h3>â• æ–°å¢ç¦®ç‰©</h3>
  <label>æ—¥æœŸï¼ˆ1â€“31ï¼‰</label>
  <input id="newDay" type="number" min="1" max="31">

  <label>å…§å®¹</label>
  <textarea id="newText" rows="3"></textarea>

  <button onclick="addGift()">æ–°å¢</button>
</div>

<div style="text-align:center;">
  <button onclick="upload()" style="padding:12px 20px;font-size:16px;">ğŸ’¾ å„²å­˜æ•´ä»½ gifts.json</button>
</div>

<div id="msg"></div>

<script>
const USER="heyyouuuuu";
const REPO="calendar12";
const FILE_PATH="gifts.json";

let gifts = {};
let token = null;

/* ---------------------------
   Token Base64 åŠ å¯†å­˜ localStorage
----------------------------*/
function saveToken(){
  const raw = document.getElementById("tokenBox").value.trim();
  if(!raw){ alert("Token ä¸å¯ç‚ºç©º"); return; }
  const encoded = btoa(raw);
  localStorage.setItem("token_enc", encoded);
  token = raw;
  alert("Token å·²ä¿å­˜ï¼");
}

function loadToken(){
  const enc = localStorage.getItem("token_enc");
  if(enc){
    token = atob(enc);
    document.getElementById("tokenBox").value = token;
  }
}
loadToken();

/* ---------------------------
        è¼‰å…¥ gifts.json
----------------------------*/
async function loadGifts(){
  const url = `https://api.github.com/repos/${USER}/${REPO}/contents/${FILE_PATH}`;
  const res = await fetch(url);
  const data = await res.json();
  const content = decodeURIComponent(escape(atob(data.content)));
  gifts = JSON.parse(content);
  renderList();
}
loadGifts();

/* ---------------------------
        é¡¯ç¤ºç¦®ç‰©æ¸…å–®ï¼ˆå¯ç·¨è¼¯ï¼‰
----------------------------*/
function renderList(){
  const box = document.getElementById("giftList");
  box.innerHTML = "";

  Object.keys(gifts).sort((a,b)=>a-b).forEach(day=>{
    const div = document.createElement("div");
    div.className="gift-item";
    
    div.innerHTML = `
      <label>æ—¥æœŸ</label>
      <input type="number" min="1" max="31" value="${day}" 
             onchange="updateDay(${day}, this.value)">
      <label>å…§å®¹</label>
      <textarea rows="2" onchange="updateGift(${day}, this.value)">${gifts[day]}</textarea>
      <button class="btn-small btn-delete" onclick="removeGift(${day})">åˆªé™¤</button>
    `;
    box.appendChild(div);
  });
}

/* ---------------------------
       ç·¨è¼¯åŠŸèƒ½
----------------------------*/
function updateDay(oldDay, newDay){
  newDay = parseInt(newDay);
  if(!newDay || newDay<1 || newDay>31){
    alert("æ—¥æœŸéœ€åœ¨ 1â€“31ï¼");
    renderList();
    return;
  }
  gifts[newDay] = gifts[oldDay];
  delete gifts[oldDay];
  renderList();
}

function updateGift(day, text){
  gifts[day] = text;
}

function removeGift(day){
  delete gifts[day];
  renderList();
}

/* æ–°å¢ç¦®ç‰© */
function addGift(){
  const d = parseInt(document.getElementById("newDay").value);
  const t = document.getElementById("newText").value.trim();
  if(!d || d<1 || d>31){ alert("æ—¥æœŸéœ€ 1â€“31"); return; }
  if(!t){ alert("å…§å®¹ä¸å¯ç©º"); return; }

  gifts[d] = t;
  document.getElementById("newDay").value = "";
  document.getElementById("newText").value = "";

  renderList();
}

/* ---------------------------
       ä¸Šå‚³è‡³ GitHub
----------------------------*/
async function upload(){

  if(!token){
    alert("è«‹å…ˆè¼¸å…¥ Token");
    return;
  }

  const url = `https://api.github.com/repos/${USER}/${REPO}/contents/${FILE_PATH}`;

  // å–å¾—æœ€æ–° SHA
  const fileInfo = await fetch(url).then(r=>r.json());

  const newContent = JSON.stringify(gifts, null, 2);

  const body = {
    message: "update gifts.json",
    content: btoa(unescape(encodeURIComponent(newContent))),
    sha: fileInfo.sha
  };

  const res = await fetch(url, {
    method:"PUT",
    headers:{
      "Authorization":"Bearer " + token,
      "Content-Type":"application/json"
    },
    body: JSON.stringify(body)
  });

  if(res.ok){
    document.getElementById("msg").innerHTML = "âœ” å·²æˆåŠŸæ›´æ–°ï¼";
  }else{
    document.getElementById("msg").innerHTML = "âŒ å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Token";
  }
}
</script>
</body>
</html>