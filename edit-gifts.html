<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸ ç·¨è¼¯ Gifts</title>
<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue","Noto Sans TC",sans-serif;
  margin:20px;
  background:#fafafa;
}
h1{font-size:1.4em;margin-bottom:10px;}
textarea{
  width:100%;
  height:300px;
  font-size:14px;
  font-family:monospace;
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
}
input{
  width:100%;
  padding:10px;
  margin:8px 0;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:14px;
}
button{
  padding:10px 16px;
  border:0;
  background:#d10000;
  color:#fff;
  font-size:14px;
  border-radius:8px;
  margin-top:10px;
}
#msg{
  margin-top:10px;
  font-size:14px;
  color:green;
}
</style>

<body>
<h1>ğŸ Gifts ç·¨è¼¯å™¨</h1>

<p>ä½ çš„ GitHub Tokenï¼š</p>
<input id="tokenInput" placeholder="ç¬¬ä¸€æ¬¡ä½¿ç”¨è«‹è¼¸å…¥ GitHub Token">

<button onclick="saveToken()">å„²å­˜ Tokenï¼ˆåªå­˜ localStorageï¼‰</button>

<p>gifts.jsonå…§å®¹ï¼š</p>
<textarea id="editor"></textarea>

<button onclick="upload()">ğŸ’¾ å„²å­˜åˆ° GitHub</button>

<div id="msg"></div>

<script>
const USER = "heyyouuuuu";
const REPO = "calendar12";
const FILE_PATH = "gifts.json";

let token = localStorage.getItem("gh_token");

document.getElementById("tokenInput").value = token || "";

// å„²å­˜ Token
function saveToken(){
  const v = document.getElementById("tokenInput").value.trim();
  if(!v){ alert("Token ä¸å¯ç‚ºç©º"); return; }
  localStorage.setItem("gh_token", v);
  token = v;
  alert("Token å·²ä¿å­˜ï¼");
}

// STEP 1ï¼šè®€å–ç¾æœ‰ gifts.json
async function loadFile(){
  const url = `https://api.github.com/repos/${USER}/${REPO}/contents/${FILE_PATH}`;
  const res = await fetch(url);
  const data = await res.json();
  const content = atob(data.content);
  document.getElementById("editor").value = content;
}
loadFile();

// STEP 2ï¼šå¯«å› GitHub
async function upload(){
  if(!token){
    alert("è«‹å…ˆè¼¸å…¥ä¸¦å„²å­˜ Token");
    return;
  }

  const newContent = document.getElementById("editor").value;

  // å…ˆå–æœ€æ–° SHA
  const url = `https://api.github.com/repos/${USER}/${REPO}/contents/${FILE_PATH}`;
  const fileInfo = await fetch(url).then(r=>r.json());

  const body = {
    message: "update gifts.json",
    content: btoa(unescape(encodeURIComponent(newContent))),
    sha: fileInfo.sha
  };

  const res = await fetch(url, {
    method:"PUT",
    headers:{
      "Authorization":"Bearer " + token,
      "Content-Type":"application/json"
    },
    body: JSON.stringify(body)
  });

  if(res.ok){
    document.getElementById("msg").innerHTML = "âœ” å·²æˆåŠŸæ›´æ–°ï¼";
  }else{
    document.getElementById("msg").innerHTML = "âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Token æˆ–æ¬Šé™ã€‚";
  }
}
</script>
</body>
</html>